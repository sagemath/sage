name: Lint

on:
  push:
    branches:
      - master
      - develop
  pull_request:
  merge_group:

concurrency:
  # Cancel previous runs of this workflow for the same branch
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Merge CI fixes from sagemath/sage
      run: |
        .github/workflows/merge-fixes.sh
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Install prerequisites
      id: deps
      run: pip install uv

    - name: Code style check with ruff
      if: ${{ !cancelled() && steps.deps.outcome == 'success' }}
      run: |
        uv run --frozen --only-group lint -- ruff check --output-format github --config .github/workflows/ruff.toml --no-preview
        uv run --frozen --only-group lint -- ruff check --output-format github --config .github/workflows/ruff.toml --preview

    - name: Code style check with relint
      if: ${{ !cancelled() && steps.deps.outcome == 'success' }}
      run: uv run --frozen --only-group lint -- relint -c src/.relint.yml -- src/sage/

    - name: Validate docstring markup as RST
      if: ${{ !cancelled() && steps.deps.outcome == 'success' }}
      run: uv run --frozen --only-group lint -- flake8 --select=RST src/sage/ --config src/tox.ini
    
    - name: TOML format check with taplo
      uses: docker://tamasfe/taplo:0.10.0
      with:
        args: format --check --diff pyproject.toml .taplo.toml 
