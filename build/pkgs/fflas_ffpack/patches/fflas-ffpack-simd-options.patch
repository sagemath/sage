--- a/fflas-ffpack/macros/common.m4	2024-05-19 03:34:34.000000000 +0800
+++ b/fflas-ffpack/macros/common.m4	2025-12-09 23:07:57.325990450 +0800
@@ -99,10 +99,151 @@
 ])dnl AX_CHECK_COMPILE_FLAGS
 
 
+dnl SIMD instruction set options
+dnl Add --disable-* options for each SIMD instruction set
+AC_DEFUN([SIMD_FLAGS],[
+    dnl SSE options
+    AC_ARG_ENABLE(sse, [AC_HELP_STRING([--disable-sse],
+        [disable SSE instructions])],
+        [enable_sse=$enableval], [enable_sse=yes])
+
+    AC_ARG_ENABLE(sse2, [AC_HELP_STRING([--disable-sse2],
+        [disable SSE2 instructions])],
+        [enable_sse2=$enableval], [enable_sse2=yes])
+
+    AC_ARG_ENABLE(sse3, [AC_HELP_STRING([--disable-sse3],
+        [disable SSE3 instructions])],
+        [enable_sse3=$enableval], [enable_sse3=yes])
+
+    AC_ARG_ENABLE(ssse3, [AC_HELP_STRING([--disable-ssse3],
+        [disable SSSE3 instructions])],
+        [enable_ssse3=$enableval], [enable_ssse3=yes])
+
+    AC_ARG_ENABLE(sse41, [AC_HELP_STRING([--disable-sse41],
+        [disable SSE4.1 instructions])],
+        [enable_sse41=$enableval], [enable_sse41=yes])
+
+    AC_ARG_ENABLE(sse42, [AC_HELP_STRING([--disable-sse42],
+        [disable SSE4.2 instructions])],
+        [enable_sse42=$enableval], [enable_sse42=yes])
+
+    dnl FMA options
+    AC_ARG_ENABLE(fma, [AC_HELP_STRING([--disable-fma],
+        [disable FMA instructions])],
+        [enable_fma=$enableval], [enable_fma=yes])
+
+    AC_ARG_ENABLE(fma4, [AC_HELP_STRING([--disable-fma4],
+        [disable FMA4 instructions])],
+        [enable_fma4=$enableval], [enable_fma4=yes])
+
+    dnl AVX options
+    AC_ARG_ENABLE(avx, [AC_HELP_STRING([--disable-avx],
+        [disable AVX instructions])],
+        [enable_avx=$enableval], [enable_avx=yes])
+
+    AC_ARG_ENABLE(avx2, [AC_HELP_STRING([--disable-avx2],
+        [disable AVX2 instructions])],
+        [enable_avx2=$enableval], [enable_avx2=yes])
+
+    dnl AVX512 options
+    AC_ARG_ENABLE(avx512f, [AC_HELP_STRING([--disable-avx512f],
+        [disable AVX512F instructions])],
+        [enable_avx512f=$enableval], [enable_avx512f=yes])
+
+    AC_ARG_ENABLE(avx512dq, [AC_HELP_STRING([--disable-avx512dq],
+        [disable AVX512DQ instructions])],
+        [enable_avx512dq=$enableval], [enable_avx512dq=yes])
+
+    AC_ARG_ENABLE(avx512vl, [AC_HELP_STRING([--disable-avx512vl],
+        [disable AVX512VL instructions])],
+        [enable_avx512vl=$enableval], [enable_avx512vl=yes])
+
+    dnl Check if any SIMD option is explicitly disabled
+    SIMD_DISABLED=no
+    AS_IF([test "x$enable_sse" = "xno" -o "x$enable_sse2" = "xno" -o \
+           "x$enable_sse3" = "xno" -o "x$enable_ssse3" = "xno" -o \
+           "x$enable_sse41" = "xno" -o "x$enable_sse42" = "xno" -o \
+           "x$enable_fma" = "xno" -o "x$enable_fma4" = "xno" -o \
+           "x$enable_avx" = "xno" -o "x$enable_avx2" = "xno" -o \
+           "x$enable_avx512f" = "xno" -o "x$enable_avx512dq" = "xno" -o \
+           "x$enable_avx512vl" = "xno"],
+          [SIMD_DISABLED=yes])
+
+    dnl Add -mno-* flags for disabled instruction sets
+    SIMD_DISABLE_FLAGS=""
+    AS_IF([test "x$enable_sse" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-sse],
+               [SIMD_DISABLE_FLAGS+=" -mno-sse"
+                AC_MSG_NOTICE([Disabling SSE instructions])])])
+
+    AS_IF([test "x$enable_sse2" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-sse2],
+               [SIMD_DISABLE_FLAGS+=" -mno-sse2"
+                AC_MSG_NOTICE([Disabling SSE2 instructions])])])
+
+    AS_IF([test "x$enable_sse3" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-sse3],
+               [SIMD_DISABLE_FLAGS+=" -mno-sse3"
+                AC_MSG_NOTICE([Disabling SSE3 instructions])])])
+
+    AS_IF([test "x$enable_ssse3" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-ssse3],
+               [SIMD_DISABLE_FLAGS+=" -mno-ssse3"
+                AC_MSG_NOTICE([Disabling SSSE3 instructions])])])
+
+    AS_IF([test "x$enable_sse41" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-sse4.1],
+               [SIMD_DISABLE_FLAGS+=" -mno-sse4.1"
+                AC_MSG_NOTICE([Disabling SSE4.1 instructions])])])
+
+    AS_IF([test "x$enable_sse42" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-sse4.2],
+               [SIMD_DISABLE_FLAGS+=" -mno-sse4.2"
+                AC_MSG_NOTICE([Disabling SSE4.2 instructions])])])
+
+    AS_IF([test "x$enable_fma" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-fma],
+               [SIMD_DISABLE_FLAGS+=" -mno-fma"
+                AC_MSG_NOTICE([Disabling FMA instructions])])])
+
+    AS_IF([test "x$enable_fma4" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-fma4],
+               [SIMD_DISABLE_FLAGS+=" -mno-fma4"
+                AC_MSG_NOTICE([Disabling FMA4 instructions])])])
+
+    AS_IF([test "x$enable_avx" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-avx],
+               [SIMD_DISABLE_FLAGS+=" -mno-avx"
+                AC_MSG_NOTICE([Disabling AVX instructions])])])
+
+    AS_IF([test "x$enable_avx2" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-avx2],
+               [SIMD_DISABLE_FLAGS+=" -mno-avx2"
+                AC_MSG_NOTICE([Disabling AVX2 instructions])])])
+
+    AS_IF([test "x$enable_avx512f" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-avx512f],
+               [SIMD_DISABLE_FLAGS+=" -mno-avx512f"
+                AC_MSG_NOTICE([Disabling AVX512F instructions])])])
+
+    AS_IF([test "x$enable_avx512dq" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-avx512dq],
+               [SIMD_DISABLE_FLAGS+=" -mno-avx512dq"
+                AC_MSG_NOTICE([Disabling AVX512DQ instructions])])])
+
+    AS_IF([test "x$enable_avx512vl" = "xno"],
+          [AX_CHECK_COMPILE_FLAG([-mno-avx512vl],
+               [SIMD_DISABLE_FLAGS+=" -mno-avx512vl"
+                AC_MSG_NOTICE([Disabling AVX512VL instructions])])])
+])
+
 dnl Append -march=native or -mcpu=native (if recognized by the compiler) to
 dnl OPTIM_FLAGS if not present in CXXFLAGS and not cross-compiling and
 dnl --without-archnative is not set
+dnl If SIMD options are disabled, also add -mno-* flags after -march=native
 AC_DEFUN([ARCH_FLAGS],[
+    AC_REQUIRE([SIMD_FLAGS])
+
     AC_ARG_WITH(archnative, [AC_HELP_STRING([--without-archnative],
         [do not use -march=native or -mcpu=native (default is to use it if not already present in CXXFLAGS)])])
 
@@ -127,6 +268,12 @@
                             OPTIM_FLAGS+=" -mcpu=native"])])])
         ], [], [], [])
     ], [], [])
+
+    dnl If SIMD options are disabled, add -mno-* flags after -march=native
+    dnl This allows using native optimizations while disabling specific instruction sets
+    AS_IF([test "x${SIMD_DISABLED}" = "xyes"],
+          [AC_MSG_NOTICE([Adding SIMD disable flags to OPTIM_FLAGS])
+           OPTIM_FLAGS+="${SIMD_DISABLE_FLAGS}"])
 ])
 
 dnl Append -mfpmath=sse to OPTIM_FLAGS on i386 and i686 architecture with SSE
